"use strict";function handleCache(e,t){var r,n=e.filename,i=void 0!==t;if(e.cache){if(!n)throw new Error("cache option requires a filename");if(r=exports.cache.get(n))return r;i||(t=fs.readFileSync(n).toString().replace(_BOM,""))}else if(!i){if(!n)throw new Error("Internal EJS error: no file name or template provided");t=fs.readFileSync(n).toString().replace(_BOM,"")}return r=exports.compile(t,e),e.cache&&exports.cache.set(n,r),r}function includeFile(e,t){var r=utils.shallowCopy({},t);if(!r.filename)throw new Error("`include` requires the 'filename' option.");return r.filename=exports.resolveInclude(e,r.filename),handleCache(r)}function includeSource(e,t){var r,n,i=utils.shallowCopy({},t);if(!i.filename)throw new Error("`include` requires the 'filename' option.");r=exports.resolveInclude(e,i.filename),n=fs.readFileSync(r).toString().replace(_BOM,""),i.filename=r;var s=new Template(n,i);return s.generateSource(),s.source}function rethrow(e,t,r,n){var i=t.split("\n"),s=Math.max(n-3,0),o=Math.min(i.length,n+3),a=i.slice(s,o).map(function(e,t){var r=t+s+1;return(r==n?" >> ":"    ")+r+"| "+e}).join("\n");throw e.path=r,e.message=(r||"ejs")+":"+n+"\n"+a+"\n\n"+e.message,e}function cpOptsInData(e,t){_OPTS.forEach(function(r){"undefined"!=typeof e[r]&&(t[r]=e[r])})}function Template(e,t){t=t||{};var r={};this.templateText=e,this.mode=null,this.truncate=!1,this.currentLine=1,this.source="",r.client=t.client||!1,r.escapeFunction=t.escape||utils.escapeXML,r.compileDebug=t.compileDebug!==!1,r.debug=!!t.debug,r.filename=t.filename,r.delimiter=t.delimiter||exports.delimiter||_DEFAULT_DELIMITER,r._with="undefined"!=typeof t._with?t._with:!0,r.cache=t.cache||!1,r.rmWhitespace=t.rmWhitespace,this.opts=r,this.regex=this.createRegex()}var fs=require("fs"),utils=require("./utils"),scopeOptionWarned=!1,_VERSION_STRING=require("../package.json").version,_DEFAULT_DELIMITER="%",_DEFAULT_LOCALS_NAME="locals",_REGEX_STRING="(<%%|<%=|<%-|<%#|<%|%>|-%>)",_OPTS=["cache","filename","delimiter","scope","context","debug","compileDebug","client","_with"],_TRAILING_SEMCOL=/;\s*$/,_BOM=/^\uFEFF/;exports.cache=utils.cache,exports.localsName=_DEFAULT_LOCALS_NAME,exports.resolveInclude=function(e,t){var r=require("path"),n=r.dirname,i=r.extname,s=r.resolve,o=s(n(t),e),a=i(e);return a||(o+=".ejs"),o},exports.compile=function(e,t){var r;return t&&t.scope&&(scopeOptionWarned||(console.warn("`scope` option is deprecated and will be removed in EJS 3"),scopeOptionWarned=!0),t.context||(t.context=t.scope),delete t.scope),r=new Template(e,t),r.compile()},exports.render=function(e,t,r){t=t||{},r=r||{};var n;return 2==arguments.length&&cpOptsInData(t,r),n=handleCache(r,e),n.call(r.context,t)},exports.renderFile=function(){var e,t=Array.prototype.slice.call(arguments),r=t.shift(),n=t.pop(),i=t.shift()||{},s=t.pop()||{};3==arguments.length&&cpOptsInData(i,s),s.filename=r;try{e=handleCache(s)(i)}catch(o){return n(o)}return n(null,e)},exports.clearCache=function(){exports.cache.reset()},Template.modes={EVAL:"eval",ESCAPED:"escaped",RAW:"raw",COMMENT:"comment",LITERAL:"literal"},Template.prototype={createRegex:function(){var e=_REGEX_STRING,t=utils.escapeRegExpChars(this.opts.delimiter);return e=e.replace(/%/g,t),new RegExp(e)},compile:function(){var e,t,r=this.opts,n=r.escapeFunction;if(r.rmWhitespace&&(this.templateText=this.templateText.replace(/\r/g,"").replace(/^\s+|\s+$/gm,"")),!this.source){this.generateSource();var i="  var __output = [];\n";r._with!==!1&&(i+="  with ("+exports.localsName+" || {}) {\n"),this.source=i+this.source,r._with!==!1&&(this.source+="  }\n"),this.source+='  return __output.join("");\n'}e=r.compileDebug?"var __line = 1\n  , __lines = "+JSON.stringify(this.templateText)+"\n  , __filename = "+(r.filename?JSON.stringify(r.filename):"undefined")+";\ntry {\n"+this.source+"} catch (e) {\n  rethrow(e, __lines, __filename, __line);\n}\n":this.source,r.debug&&console.log(e),r.client&&(e="escape = escape || "+n.toString()+";\n"+e,r.compileDebug&&(e="rethrow = rethrow || "+rethrow.toString()+";\n"+e));try{t=new Function(exports.localsName+", escape, include, rethrow",e)}catch(s){throw s instanceof SyntaxError&&(r.filename&&(s.message+=" in "+r.filename),s.message+=" while compiling ejs"),s}return r.client?t:function(e){var i=function(t,n){var i=utils.shallowCopy({},e);return n&&(i=utils.shallowCopy(i,n)),includeFile(t,r)(i)};return t(e||{},n,i,rethrow)}},generateSource:function(){var e=this,t=this.parseTemplateText(),r=this.opts.delimiter;t&&t.length&&t.forEach(function(n,i){var s,o,a,c;if(0===n.indexOf("<"+r)&&0!==n.indexOf("<"+r+r)&&(s=t[i+2],s!=r+">"&&s!="-"+r+">"))throw new Error('Could not find matching close tag for "'+n+'".');(o=n.match(/^\s*include\s+(\S+)/))?(a=utils.shallowCopy({},e.opts),c=includeSource(o[1],a),c="    ; (function(){\n"+c+"    ; })()\n",e.source+=c):e.scanLine(n)})},parseTemplateText:function(){for(var e,t,r=this.templateText,n=this.regex,i=n.exec(r),s=[];i;)e=i.index,t=n.lastIndex,0!==e&&(s.push(r.substring(0,e)),r=r.slice(e)),s.push(i[0]),r=r.slice(i[0].length),i=n.exec(r);return r&&s.push(r),s},scanLine:function(e){function t(){r.truncate?(e=e.replace("\n",""),r.truncate=!1):r.opts.rmWhitespace&&(e=e.replace(/^\n/,"")),e&&(e=e.replace(/\\/g,"\\\\"),e=e.replace(/\n/g,"\\n"),e=e.replace(/\r/g,"\\r"),e=e.replace(/"/g,'\\"'),r.source+='    ; __output.push("'+e+'")\n')}var r=this,n=this.opts.delimiter,i=0;switch(i=e.split("\n").length-1,e){case"<"+n:this.mode=Template.modes.EVAL;break;case"<"+n+"=":this.mode=Template.modes.ESCAPED;break;case"<"+n+"-":this.mode=Template.modes.RAW;break;case"<"+n+"#":this.mode=Template.modes.COMMENT;break;case"<"+n+n:this.mode=Template.modes.LITERAL,this.source+='    ; __output.push("'+e.replace("<"+n+n,"<"+n)+'")\n';break;case n+">":case"-"+n+">":this.mode==Template.modes.LITERAL&&t(),this.mode=null,this.truncate=0===e.indexOf("-");break;default:if(this.mode){switch(this.mode){case Template.modes.EVAL:case Template.modes.ESCAPED:case Template.modes.RAW:e.lastIndexOf("//")>e.lastIndexOf("\n")&&(e+="\n")}switch(this.mode){case Template.modes.EVAL:this.source+="    ; "+e+"\n";break;case Template.modes.ESCAPED:this.source+="    ; __output.push(escape("+e.replace(_TRAILING_SEMCOL,"").trim()+"))\n";break;case Template.modes.RAW:this.source+="    ; __output.push("+e.replace(_TRAILING_SEMCOL,"").trim()+")\n";break;case Template.modes.COMMENT:break;case Template.modes.LITERAL:t()}}else t()}r.opts.compileDebug&&i&&(this.currentLine+=i,this.source+="    ; __line = "+this.currentLine+"\n")}},exports.__express=exports.renderFile,require.extensions&&(require.extensions[".ejs"]=function(e,t){t=t||e.filename;var r={filename:t,client:!0},n=fs.readFileSync(t).toString(),i=exports.compile(n,r);e._compile("module.exports = "+i.toString()+";",t)}),exports.VERSION=_VERSION_STRING,"undefined"!=typeof window&&(window.ejs=exports);