function parse(e){return parseInheritance(parseConditionals(e))}function parseInheritance(e){return e.replace(/^ *(\w+)\.prototype\.__proto__ * = *(\w+)\.prototype *;?/gm,function(e,r,n){return r+".prototype = new "+n+";\n"+r+".prototype.constructor = "+r+";\n"})}function parseConditionals(e){for(var r,n,o=e.split("\n"),i=o.length,t=!0,s=!1,u=[],l=0;i>l;++l)r=o[l],/^ *\/\/ *if *(node|browser)/gm.exec(r)?(n=RegExp.$1,t=s="browser"==n):/^ *\/\/ *end/.test(r)?(t=!0,s=!1):s?u.push(r.replace(/^( *)\/\//,"$1")):t&&u.push(r);return u.join("\n")}function compile(){var e="";e+="ejs = (function(){\n",e+="\n// CommonJS require()\n\n",e+=browser.require+"\n\n",e+="require.modules = {};\n\n",e+="require.resolve = "+browser.resolve+";\n\n",e+="require.register = "+browser.register+";\n\n",e+="require.relative = "+browser.relative+";\n\n",args.forEach(function(r){var n=files[r];r=r.replace("lib/",""),e+='\nrequire.register("'+r+'", function(module, exports, require){\n',e+=n,e+="\n}); // module: "+r+"\n"}),e+='\n return require("ejs");\n})();',fs.writeFile("ejs.js",e,function(e){if(e)throw e;console.log("  [90m create : [0m[36m%s[0m","ejs.js"),console.log()})}var fs=require("fs"),args=process.argv.slice(2),pending=args.length,files={};console.log(""),args.forEach(function(e){e.replace("lib/","");fs.readFile(e,"utf8",function(r,n){if(r)throw r;console.log("  [90mcompile : [0m[36m%s[0m",e),files[e]=parse(n),--pending||compile()})});var browser={require:function e(r){if("fs"==r)return{};if("path"==r)return{};var n=e.resolve(r),o=e.modules[n];if(!o)throw new Error('failed to require "'+r+'"');return o.exports||(o.exports={},o.call(o.exports,o,o.exports,e.relative(n))),o.exports},resolve:function(e){var r=e,n=e+".js",o=e+"/index.js";return require.modules[n]&&n||require.modules[o]&&o||r},relative:function(e){return function(r){if("."!=r.substr(0,1))return require(r);var n=e.split("/"),o=r.split("/");n.pop();for(var i=0;i<o.length;i++){var t=o[i];".."==t?n.pop():"."!=t&&n.push(t)}return require(n.join("/"))}},register:function(e,r){require.modules[e]=r}};